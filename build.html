<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-12-19 Sun 03:30 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>About this Portfolio</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Sean Gallagher">
<link
    href="https://cdn.simplecss.org/simple.min.css"
    rel="stylesheet"
    type="text/css"
/>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<header id="header" class="status">
<h1>Sean Gallagher</h1>
<nav>
  <a href="/">Home</a>
  <a href="/stocks.html">The STOCKS Application</a>
  <a href="/build.html">How it's Made</a>
</nav>
</header>
<main id="content">

<article id="outline-container-org9751d8c" class="outline-2">
<h2 id="org9751d8c">How the Sausage Gets Made</h2>
<div class="outline-text-2" id="text-org9751d8c">
<p>
This portfolio uses Emacs' <code>org-mode</code> as its content authoring system.
In the future, I might spend more time talking about this,
    but this document currently exists solely as a literate build script
    for the publishing configuration.
</p>
</div>
<section id="outline-container-orgbce1dda" class="outline-3">
<h3 id="orgbce1dda">The scripts</h3>
<div class="outline-text-3" id="text-orgbce1dda">
<p>
There are two scripts involved in the build process.
The first, a shell script, handles launching the build script,
    while the second is the Emacs Lisp script that does the actual building.
</p>
</div>
<section id="outline-container-org0c056cd" class="outline-4">
<h4 id="org0c056cd"><code>build.sh</code></h4>
<div class="outline-text-4" id="text-org0c056cd">
<p>
Originally, the shell script simply launched the Lisp script,
    but it didn't take long to realize
    that I was grossly underutilizing the script's automation potential.
While it can still run a single on-demand build
    when run with no arguments
    (and does in the GitHub Pages CI job),
    passing the <code>start</code> argument
    launches a full auto-rebuilding local development environment
    that I've tailored for my AwesomeWM setup,
    including a Chromium app window,
    Chromium dev tools,
    a browser auto-reloader (I'm using <a href="https://github.com/tapio/live-server">live-server</a>),
    and an <code>inotifywait</code>-powered runner for the publishing script.
The final script looks like this:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/bin/</span><span style="font-weight: bold;">bash</span>

<span style="font-weight: bold;">publish</span> () {
  emacs -Q --script publish.el
}

<span style="font-weight: bold;">if</span> [ $<span style="font-weight: bold; font-style: italic;">#</span> -gt 0 ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">case</span> <span style="font-style: italic;">"$1"</span><span style="font-weight: bold;"> in</span>
    <span style="font-style: italic;">"start"</span>)
      alacritty -e <span style="font-style: italic;">\</span>
        live-server public/ --watch=public/ --port=3000 --no-browser &amp;
      sleep 1
      chromium --app=<span style="font-style: italic;">"http://localhost:3000"</span> --class=noswallow <span style="font-style: italic;">\</span>
        --auto-open-devtools-for-tabs --force-dark-mode <span style="font-style: italic;">\</span>
        &gt;/dev/null 2&gt;&amp;1 &amp;
      inotifywait -rm ./ -e close_write |
        <span style="font-weight: bold;">while </span><span style="font-weight: bold;">read</span> directory action file; <span style="font-weight: bold;">do</span>
          <span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"$file"</span> = <span style="font-style: italic;">"publish.el"</span> ] || [ -z <span style="font-style: italic;">"${file##*.org}"</span> ];
          <span style="font-weight: bold;">then</span>
            <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Detected change in ${directory}${file}"</span>
            publish
          <span style="font-weight: bold;">fi</span>
        <span style="font-weight: bold;">done</span>
      ;;
    <span style="font-style: italic;">"clean"</span>)
      rm -rf public archive
      ;;
  <span style="font-weight: bold;">esac</span>
<span style="font-weight: bold;">else</span>
  publish
<span style="font-weight: bold;">fi</span>
</pre>
</div>
</div>
</section>

<section id="outline-container-org380f3a4" class="outline-4">
<h4 id="org380f3a4"><code>publish.el</code></h4>
<div class="outline-text-4" id="text-org380f3a4">
<p>
The publishing script is more involved,
    but almost all of it is configuring the publishing environment.
</p>
</div>
<section id="outline-container-org5549acf" class="outline-5">
<h5 id="org5549acf">Dependencies</h5>
<div class="outline-text-5" id="text-org5549acf">
<p>
First, we pull in Emacs' package management and initialize it:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">require</span> '<span style="font-weight: bold; text-decoration: underline;">package</span>)
(<span style="font-weight: bold;">setq</span> package-user-dir (expand-file-name <span style="font-style: italic;">"./.packages"</span>))
(<span style="font-weight: bold;">setq</span> package-archives '((<span style="font-style: italic;">"melpa"</span> . <span style="font-style: italic;">"https://melpa.org/packages/"</span>)
                         (<span style="font-style: italic;">"elpa"</span> . <span style="font-style: italic;">"https://elpa.gnu.org/packages/"</span>)))
(package-initialize)
(<span style="font-weight: bold;">unless</span> package-archive-contents
  (package-refresh-contents))
</pre>
</div>
<p>
Once we have the package system up and running,
    we make sure Emacs has installed the dependencies:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(package-install 'htmlize)
</pre>
</div>
<p>
The last initialization step
    is to require <code>ox-publish</code> so we can actually publish:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">require</span> '<span style="font-weight: bold; text-decoration: underline;">ox-publish</span>)
</pre>
</div>
</div>
</section>

<section id="outline-container-orgc673c6e" class="outline-5">
<h5 id="orgc673c6e">Configuration</h5>
<div class="outline-text-5" id="text-orgc673c6e">
<p>
We need to set a few variables explicitly,
    mostly for including stylesheets
    and our custom pre/postamble.
Since we aren't loading my personal config,
    we start by setting my name and email address:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">setq</span> user-full-name <span style="font-style: italic;">"Sean Gallagher"</span>
      user-mail-address <span style="font-style: italic;">"seangllghr@gmail.com"</span>)
</pre>
</div>
<p>
We declare strings
    to hold our custom HTML header
    (the footer is short, so we set that inline),
    as well as a link to the <a href="https://simplecss.org/">Simple.css</a> CDN:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">setq</span>
 simplecss <span style="font-style: italic;">"&lt;link</span>
<span style="font-style: italic;">    href=\"https://cdn.simplecss.org/simple.min.css\"</span>
<span style="font-style: italic;">    rel=\"stylesheet\"</span>
<span style="font-style: italic;">    type=\"text/css\"</span>
<span style="font-style: italic;">/&gt;"</span>
 header <span style="font-style: italic;">"&lt;h1&gt;Sean Gallagher&lt;/h1&gt;</span>
<span style="font-style: italic;">&lt;nav&gt;</span>
<span style="font-style: italic;">  &lt;a href=\"/\"&gt;Home&lt;/a&gt;</span>
<span style="font-style: italic;">  &lt;a href=\"/stocks.html\"&gt;The STOCKS Application&lt;/a&gt;</span>
<span style="font-style: italic;">  &lt;a href=\"/build.html\"&gt;How it's Made&lt;/a&gt;</span>
<span style="font-style: italic;">&lt;/nav&gt;"</span>)
</pre>
</div>
<p>
We can then use these values to explicitly set the appropriate <code>org-mode</code> values:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">setq</span> org-html-head simplecss
      org-html-preamble header
      org-html-postamble <span style="font-style: italic;">"&lt;p&gt;&amp;copy;&amp;thinsp;2021 %a&lt;br&gt;%e&lt;/p&gt;"</span>)
</pre>
</div>

<p>
Finally, we set our main configuration <code>alist</code>,
    which declares our publish targets:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">setq</span> org-publish-project-alist
      (list
       (list <span style="font-style: italic;">"seangllghr.github.io:content"</span>
             <span style="font-weight: bold;">:language</span> <span style="font-style: italic;">"en"</span>
             <span style="font-weight: bold;">:base-directory</span> <span style="font-style: italic;">"./src"</span>
             <span style="font-weight: bold;">:recursive</span> t
             <span style="font-weight: bold;">:base-extension</span> <span style="font-style: italic;">"org"</span>
             <span style="font-weight: bold;">:publishing-directory</span> <span style="font-style: italic;">"./public"</span>
             <span style="font-weight: bold;">:publishing-function</span> 'org-html-publish-to-html
             <span style="font-weight: bold;">:headline-levels</span> 5
             <span style="font-weight: bold;">:html-divs</span> '((preamble <span style="font-style: italic;">"header"</span> <span style="font-style: italic;">"header"</span>)
                          (content <span style="font-style: italic;">"main"</span> <span style="font-style: italic;">"content"</span>)
                          (postamble <span style="font-style: italic;">"footer"</span> <span style="font-style: italic;">"footer"</span>))
             <span style="font-weight: bold;">:html-doctype</span> <span style="font-style: italic;">"html5"</span>
             <span style="font-weight: bold;">:html-head-include-default-style</span> nil
             <span style="font-weight: bold;">:html-head-include-scripts</span> nil
             <span style="font-weight: bold;">:html-html5-fancy</span> t
             <span style="font-weight: bold;">:html-indent</span> nil
             <span style="font-weight: bold;">:html-validation-link</span> nil
             <span style="font-weight: bold;">:section-numbers</span> nil
             <span style="font-weight: bold;">:with-date</span> nil
             <span style="font-weight: bold;">:with-author</span> t
             <span style="font-weight: bold;">:with-title</span> nil
             <span style="font-weight: bold;">:with-toc</span> nil)
       (list <span style="font-style: italic;">"seangllghr.github.io:static"</span>
             <span style="font-weight: bold;">:base-directory</span> <span style="font-style: italic;">"./src"</span>
             <span style="font-weight: bold;">:recursive</span> t
             <span style="font-weight: bold;">:base-extension</span> <span style="font-style: italic;">"css</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-style: italic;">jpg</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-style: italic;">gif</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-style: italic;">png</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-style: italic;">svg"</span>
             <span style="font-weight: bold;">:publishing-directory</span> <span style="font-style: italic;">"./public"</span>
             <span style="font-weight: bold;">:publishing-function</span> 'org-publish-attachment)))
(<span style="font-weight: bold;">if</span> (string= (system-name) <span style="font-style: italic;">"Asgard"</span>)
    (<span style="font-weight: bold;">setq</span> org-publish-project-alist
          (append org-publish-project-alist
                  (list
                   (list <span style="font-style: italic;">"seangllghr.github.io:archive"</span>
                         <span style="font-weight: bold;">:base-directory</span> <span style="font-style: italic;">"./src"</span>
                         <span style="font-weight: bold;">:recursive</span> t
                         <span style="font-weight: bold;">:base-extension</span> <span style="font-style: italic;">"org"</span>
                         <span style="font-weight: bold;">:exclude</span> <span style="font-style: italic;">"</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">(</span><span style="font-style: italic;">build</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">)</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">(</span><span style="font-style: italic;">index</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">)</span><span style="font-style: italic;">.org"</span>
                         <span style="font-weight: bold;">:publishing-directory</span> <span style="font-style: italic;">"./archive"</span>
                         <span style="font-weight: bold;">:publishing-function</span> 'org-latex-publish-to-latex)))))
</pre>
</div>

<p>
There are three publish processes in here:
    an org-to-HTML process that generates the content pages,
    a process to copy over any static assets,
    and — if we're on my local machine — a
    final job to generate \LaTeX files from the relevant <code>org</code> files,
    which I'll turn into PDFs using <code>latexmk</code> on my local machine.
The last job gets appended only if
    the hostname matches my primary workstation;<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
    this saves GitHub's CI servers some time exporting the LaTeX files,
    which I'm sure they appreciate.
</p>

<p>
Finally, we run the publishing command:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-publish-all t)
(message <span style="font-style: italic;">"Build complete"</span>)
</pre>
</div>
</div>
</section>
</section>
</section>
</article>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara">Isn't Lisp such an elegant language?
    With all of those parentheses and bizarre indentation&#x2026; 🤌
    Joking aside,
    that took far too long to puzzle out.
    Who thinks about code that way?
    I love how powerful Emacs and org-mode are,
    but I don't love actually programming it.</div></div>


</div>
</div></main>
<footer id="footer" class="status">
<p>&copy;&thinsp;2021 Sean Gallagher<br><a href="mailto:seangllghr@gmail.com">seangllghr@gmail.com</a></p>
</footer>
</body>
</html>

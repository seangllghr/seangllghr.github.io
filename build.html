<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-12-20 Mon 01:21 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>About this Portfolio</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Sean Gallagher">
<link
    href="https://cdn.simplecss.org/simple.min.css"
    rel="stylesheet"
    type="text/css"
/>
<link
    href="/styles/styles.css"
    rel="stylesheet"
    type="text/css"
/>
</head>
<body>
<header id="header" class="status">
<h1>Sean Gallagher</h1>
<nav>
  <a href="/">Home</a>
  <a href="/stocks.html">The STOCKS Application</a>
  <a href="/build.html">How it's Made</a>
</nav>
</header>
<main id="content">

<article id="outline-container-org794c475" class="outline-2">
<h2 id="org794c475">How the Sausage Gets Made</h2>
<div class="outline-text-2" id="text-org794c475">
<p>
This portfolio uses Emacs' <code>org-mode</code> as its content authoring system.
In the future, I might spend more time talking about this,
    but this document currently exists solely as a literate build script
    for the publishing configuration.
Before we start,
    a note on terminology:
    I use "org" on its own
    to refer to the lightweight markup syntax used by <code>org-mode</code>,
    as well as files written in the format ("org files").
Additionally, I'll generally set the name of the Emacs mode in <code>fixed-pitch</code>,
    like I would set the names of functions, modules, variables, and the like.
In the original org sources,
    I try to use <code>~tildes~</code> for such tokens,
    and <code>=equals=</code>  for other verbatim text and the names of files,
    though they render identically in HTML<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>.
</p>
</div>
<section id="outline-container-org865ee9d" class="outline-3">
<h3 id="org865ee9d">The scripts</h3>
<div class="outline-text-3" id="text-org865ee9d">
<p>
There are two scripts involved in the build process.
The first, a shell script, handles launching the build script,
    while the second is the Emacs Lisp script that does the actual building.
</p>
</div>
<section id="outline-container-orgd216628" class="outline-4">
<h4 id="orgd216628"><code>build.sh</code></h4>
<div class="outline-text-4" id="text-orgd216628">
<p>
Originally, the shell script simply launched the Lisp script,
    but it didn't take long to realize
    that I was grossly underutilizing the script's automation potential.
While it can still run a single on-demand build
    when run with no arguments
    (and does in the GitHub Pages CI job),
    passing the <code>start</code> argument
    launches a full auto-rebuilding local development environment
    that I've tailored for my AwesomeWM setup,
    including a Chromium app window,
    Chromium dev tools,
    a browser auto-reloader (I'm using <a href="https://github.com/tapio/live-server">live-server</a>),
    and an <code>inotifywait</code>-powered runner for the publishing script.
The final script looks like this:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/bin/</span><span style="font-weight: bold;">bash</span>

<span style="font-weight: bold;">publish</span> () {
  emacs -Q --script publish.el
}

<span style="font-weight: bold;">if</span> [ $<span style="font-weight: bold; font-style: italic;">#</span> -gt 0 ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">case</span> <span style="font-style: italic;">"$1"</span><span style="font-weight: bold;"> in</span>
    <span style="font-style: italic;">"start"</span>)
      alacritty -e <span style="font-style: italic;">\</span>
        live-server public/ --port=3000 --no-browser &amp;
      sleep 1
      chromium --app=<span style="font-style: italic;">"http://localhost:3000"</span> --class=noswallow <span style="font-style: italic;">\</span>
        --auto-open-devtools-for-tabs --force-dark-mode <span style="font-style: italic;">\</span>
        &gt;/dev/null 2&gt;&amp;1 &amp;
      inotifywait -rm ./ -e close_write |
        <span style="font-weight: bold;">while </span><span style="font-weight: bold;">read</span> directory action file; <span style="font-weight: bold;">do</span>
          <span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"$file"</span> = <span style="font-style: italic;">"publish.el"</span> ] || [ -z <span style="font-style: italic;">"${directory##./src*}"</span> ];
          <span style="font-weight: bold;">then</span>
            <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Detected change in ${directory}${file}"</span>
            publish
          <span style="font-weight: bold;">fi</span>
        <span style="font-weight: bold;">done</span>
      ;;
    <span style="font-style: italic;">"clean"</span>)
      rm -rf public archive
      ;;
  <span style="font-weight: bold;">esac</span>
<span style="font-weight: bold;">else</span>
  publish
<span style="font-weight: bold;">fi</span>
</pre>
</div>
</div>
</section>

<section id="outline-container-orge9ae42a" class="outline-4">
<h4 id="orge9ae42a"><code>publish.el</code></h4>
<div class="outline-text-4" id="text-orge9ae42a">
<p>
The publishing script is more involved,
    but almost all of it is configuring the publishing environment.
</p>
</div>
<section id="outline-container-org7f8bbdb" class="outline-5">
<h5 id="org7f8bbdb">Dependencies</h5>
<div class="outline-text-5" id="text-org7f8bbdb">
<p>
First, we pull in Emacs' package management and initialize it:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">require</span> '<span style="font-weight: bold; text-decoration: underline;">package</span>)
(<span style="font-weight: bold;">setq</span> package-user-dir (expand-file-name <span style="font-style: italic;">"./.packages"</span>))
(<span style="font-weight: bold;">setq</span> package-archives '((<span style="font-style: italic;">"melpa"</span> . <span style="font-style: italic;">"https://melpa.org/packages/"</span>)
                         (<span style="font-style: italic;">"elpa"</span> . <span style="font-style: italic;">"https://elpa.gnu.org/packages/"</span>)))
(package-initialize)
(<span style="font-weight: bold;">unless</span> package-archive-contents
  (package-refresh-contents))
</pre>
</div>
<p>
Once we have the package system up and running,
    we make sure Emacs has installed the dependencies:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(package-install 'htmlize)
</pre>
</div>
<p>
The last initialization step
    is to require <code>ox-publish</code> so we can actually publish:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">require</span> '<span style="font-weight: bold; text-decoration: underline;">ox-publish</span>)
</pre>
</div>
</div>
</section>

<section id="outline-container-org311f49b" class="outline-5">
<h5 id="org311f49b">Configuration</h5>
<div class="outline-text-5" id="text-org311f49b">
<p>
We need to set a few variables explicitly,
    mostly for including stylesheets
    and our custom pre/postamble.
Since we aren't loading my personal config,
    we start by setting my name and email address:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">setq</span> user-full-name <span style="font-style: italic;">"Sean Gallagher"</span>
      user-mail-address <span style="font-style: italic;">"seangllghr@gmail.com"</span>)
</pre>
</div>
<p>
We declare strings
    to hold our custom HTML header
    (the footer is short, so we set that inline),
    as well as a link to the <a href="https://simplecss.org/">Simple.css</a> CDN:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">setq</span>
 styles <span style="font-style: italic;">"&lt;link</span>
<span style="font-style: italic;">    href=\"https://cdn.simplecss.org/simple.min.css\"</span>
<span style="font-style: italic;">    rel=\"stylesheet\"</span>
<span style="font-style: italic;">    type=\"text/css\"</span>
<span style="font-style: italic;">/&gt;</span>
<span style="font-style: italic;">&lt;link</span>
<span style="font-style: italic;">    href=\"/styles/styles.css\"</span>
<span style="font-style: italic;">    rel=\"stylesheet\"</span>
<span style="font-style: italic;">    type=\"text/css\"</span>
<span style="font-style: italic;">/&gt;"</span>
 header <span style="font-style: italic;">"&lt;h1&gt;Sean Gallagher&lt;/h1&gt;</span>
<span style="font-style: italic;">&lt;nav&gt;</span>
<span style="font-style: italic;">  &lt;a href=\"/\"&gt;Home&lt;/a&gt;</span>
<span style="font-style: italic;">  &lt;a href=\"/stocks.html\"&gt;The STOCKS Application&lt;/a&gt;</span>
<span style="font-style: italic;">  &lt;a href=\"/build.html\"&gt;How it's Made&lt;/a&gt;</span>
<span style="font-style: italic;">&lt;/nav&gt;"</span>)
</pre>
</div>
<p>
We can then use these values to explicitly set the appropriate <code>org-mode</code> values:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">setq</span> org-html-head styles
      org-html-preamble header
      org-html-postamble <span style="font-style: italic;">"&lt;p&gt;&amp;copy;&amp;thinsp;2021 %a&lt;br&gt;%e&lt;/p&gt;"</span>
      org-src-preserve-indentation t)
</pre>
</div>
<p>
If we're running on my home workstation
    (and, therefore, generating  $\mathrm{\LaTeX}$  files),
    we also need to change some relevant export settings.
The first part of this monstrous nightmare defines a list of packages
    that the exporter should include,
    while the second defines the remainder of the document preamble:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">if</span> (string= (system-name) <span style="font-style: italic;">"Asgard"</span>)
    (<span style="font-weight: bold;">setq</span> org-latex-default-packages-alist
          '((<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"graphicx"</span>  t)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"grffile"</span>   t)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"longtable"</span> nil)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"wrapfig"</span>   nil)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"rotating"</span>  nil)
            (<span style="font-style: italic;">"normalem"</span>     <span style="font-style: italic;">"ulem"</span>      t)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"amsmath"</span>   t)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"textcomp"</span>  t)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"amssymb"</span>   t)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"capt-of"</span>   nil)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"titling"</span>   t)
            (<span style="font-style: italic;">"margin=1in"</span>   <span style="font-style: italic;">"geometry"</span>  nil)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"fontspec"</span>  nil)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"setspace"</span>  nil)
            (<span style="font-style: italic;">"tiny,compact"</span> <span style="font-style: italic;">"titlesec"</span>  nil)
            (<span style="font-style: italic;">"small"</span>        <span style="font-style: italic;">"caption"</span>   nil)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"enumitem"</span>  nil)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"unicode-math"</span> nil)
            (<span style="font-style: italic;">"x11names"</span>     <span style="font-style: italic;">"xcolor"</span>    nil)
            (<span style="font-style: italic;">""</span>             <span style="font-style: italic;">"minted"</span>    nil)
            (<span style="font-style: italic;">"colorlinks=true,allcolors=darkgray"</span> <span style="font-style: italic;">"hyperref"</span> t))
          org-latex-classes
          '((<span style="font-style: italic;">"article"</span>
             <span style="font-style: italic;">"\\documentclass[11pt]{article}</span>
<span style="font-style: italic;">[DEFAULT-PACKAGES]</span>
<span style="font-style: italic;">\\setmainfont{TeX Gyre Pagella}[Ligatures=TeX]</span>
<span style="font-style: italic;">\\setsansfont{TeX Gyre Heros}[Ligatures=TeX]</span>
<span style="font-style: italic;">\\setmonofont{JetBrains Mono}[Scale=0.8]</span>
<span style="font-style: italic;">\\setmathfont{Asana Math}</span>
<span style="font-style: italic;">\\makeatletter</span>
<span style="font-style: italic;">\\def\\@maketitle{%</span>
<span style="font-style: italic;">\\singlespacing</span>
<span style="font-style: italic;">\\begin{center}%</span>
<span style="font-style: italic;">{\\LARGE \\@title \\par}%</span>
<span style="font-style: italic;">\\vskip 1.5em%</span>
<span style="font-style: italic;">{\\large \\@author}%</span>
<span style="font-style: italic;">\\end{center}%</span>
<span style="font-style: italic;">\\par</span>
<span style="font-style: italic;">\\vskip 1.5em}</span>
<span style="font-style: italic;">\\doublespacing</span>
<span style="font-style: italic;">\\makeatother</span>
<span style="font-style: italic;">\\setminted{baselinestretch=1,linenos,numbersep=4pt,obeytabs=true}"</span>
             (<span style="font-style: italic;">"\\section{%s}"</span> . <span style="font-style: italic;">"\\section*{%s}"</span>)
             (<span style="font-style: italic;">"\\subsection{%s}"</span> . <span style="font-style: italic;">"\\subsection*{%s}"</span>)
             (<span style="font-style: italic;">"\\subsubsection{%s}"</span> . <span style="font-style: italic;">"\\subsubsection*{%s}"</span>)
             (<span style="font-style: italic;">"\\paragraph{%s}"</span> . <span style="font-style: italic;">"\\paragraph*{%s}"</span>)
             (<span style="font-style: italic;">"\\subparagraph{%s}"</span> . <span style="font-style: italic;">"\\subparagraph*{%s}"</span>)))
          ))
</pre>
</div>

<p>
Finally, we set our main configuration <code>alist</code>,
    which declares our publish targets:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">setq</span> org-publish-project-alist
      (list
       (list <span style="font-style: italic;">"seangllghr.github.io:content"</span>
             <span style="font-weight: bold;">:language</span> <span style="font-style: italic;">"en"</span>
             <span style="font-weight: bold;">:base-directory</span> <span style="font-style: italic;">"./src"</span>
             <span style="font-weight: bold;">:recursive</span> t
             <span style="font-weight: bold;">:base-extension</span> <span style="font-style: italic;">"org"</span>
             <span style="font-weight: bold;">:publishing-directory</span> <span style="font-style: italic;">"./public"</span>
             <span style="font-weight: bold;">:publishing-function</span> 'org-html-publish-to-html
             <span style="font-weight: bold;">:headline-levels</span> 5
             <span style="font-weight: bold;">:html-divs</span> '((preamble <span style="font-style: italic;">"header"</span> <span style="font-style: italic;">"header"</span>)
                          (content <span style="font-style: italic;">"main"</span> <span style="font-style: italic;">"content"</span>)
                          (postamble <span style="font-style: italic;">"footer"</span> <span style="font-style: italic;">"footer"</span>))
             <span style="font-weight: bold;">:html-doctype</span> <span style="font-style: italic;">"html5"</span>
             <span style="font-weight: bold;">:html-head-include-default-style</span> nil
             <span style="font-weight: bold;">:html-head-include-scripts</span> nil
             <span style="font-weight: bold;">:html-html5-fancy</span> t
             <span style="font-weight: bold;">:html-indent</span> nil
             <span style="font-weight: bold;">:html-validation-link</span> nil
             <span style="font-weight: bold;">:section-numbers</span> nil
             <span style="font-weight: bold;">:with-date</span> nil
             <span style="font-weight: bold;">:with-author</span> t
             <span style="font-weight: bold;">:with-title</span> nil
             <span style="font-weight: bold;">:with-toc</span> nil)
       (list <span style="font-style: italic;">"seangllghr.github.io:static"</span>
             <span style="font-weight: bold;">:base-directory</span> <span style="font-style: italic;">"./src"</span>
             <span style="font-weight: bold;">:recursive</span> t
             <span style="font-weight: bold;">:base-extension</span> <span style="font-style: italic;">"css</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-style: italic;">jpg</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-style: italic;">gif</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-style: italic;">png</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-style: italic;">svg"</span>
             <span style="font-weight: bold;">:publishing-directory</span> <span style="font-style: italic;">"./public"</span>
             <span style="font-weight: bold;">:publishing-function</span> 'org-publish-attachment)))
(<span style="font-weight: bold;">setq</span> latex-publish-alist
      (list
       (list <span style="font-style: italic;">"seangllghr.github.io:archive"</span>
             <span style="font-weight: bold;">:base-directory</span> <span style="font-style: italic;">"./src"</span>
             <span style="font-weight: bold;">:recursive</span> t
             <span style="font-weight: bold;">:base-extension</span> <span style="font-style: italic;">"org"</span>
             <span style="font-weight: bold;">:exclude</span> <span style="font-style: italic;">"</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">(</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">(</span><span style="font-style: italic;">build</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">)</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">|</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">(</span><span style="font-style: italic;">stocks</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">)</span><span style="font-weight: bold; font-style: italic;">\\</span><span style="font-weight: bold; font-style: italic;">)</span><span style="font-style: italic;">.org"</span>
             <span style="font-weight: bold;">:publishing-directory</span> <span style="font-style: italic;">"./archive"</span>
             <span style="font-weight: bold;">:publishing-function</span> 'org-latex-publish-to-latex
             <span style="font-weight: bold;">:headline-levels</span> 5
             <span style="font-weight: bold;">:latex-listings</span> 'minted
             <span style="font-weight: bold;">:section-numbers</span> nil
             <span style="font-weight: bold;">:with-toc</span> nil)))
(<span style="font-weight: bold;">if</span> (string= (system-name) <span style="font-style: italic;">"Asgard"</span>)
    (<span style="font-weight: bold;">setq</span> org-publish-project-alist
          (append org-publish-project-alist latex-publish-alist)))
</pre>
</div>

<p>
There are three publish processes in here:
    an org-to-HTML process that generates the content pages,
    a process to copy over any static assets,
    andâ€Šâ€”â€Šif we're on my local machineâ€Šâ€”â€Ša final job
    to generate  $\mathrm{\LaTeX}$  files
    from the relevant org files,
    which I'll turn into PDFs using <code>latexmk</code> on my local machine.
The last job gets appended only if
    the hostname matches my primary workstation;<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>
    this saves GitHub's CI servers some time exporting the LaTeX files,
    which I'm sure they appreciate.
</p>

<p>
Finally, we run the publishing command:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(org-publish-all t)
(message <span style="font-style: italic;">"Build complete"</span>)
</pre>
</div>
</div>
</section>
</section>
</section>
</article>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara">At some point,
        when I have more time,
        I'll probably write a custom exporter for HTML,
        both to differentiate tilde and equals
        (I'm thinking <code>&lt;samp&gt;</code> for the latter)
        and to wrap footnotes in a proper &lt;aside&gt;.</div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara">Isn't Lisp such an elegant language?
    With all of those parentheses and bizarre indentation&#x2026; ðŸ¤Œ
    Joking aside,
    that took far too long to puzzle out.
    Who thinks about code that way?
    I love how powerful Emacs and org-mode are,
    but I don't love actually programming it.</div></div>


</div>
</div></main>
<footer id="footer" class="status">
<p>&copy;&thinsp;2021 Sean Gallagher<br><a href="mailto:seangllghr@gmail.com">seangllghr@gmail.com</a></p>
</footer>
</body>
</html>
